function WindowSpeechEngine(){let e=this;function t(t,n,o){if(t&&""!==t.trim()&&voices.voices.free&&(!voices.free||0!==Object.keys(voices.voices.free).length))return r().then((()=>new Promise((r=>{e.utterThis=new SpeechSynthesisUtterance,e.utterThis.text=t;let i="";reader.previewVoiceKey?(i=reader.previewVoiceKey,reader.previewVoiceKey=""):i="prem"===readingBar.settings.voiceType?readingBar.settings.premVoice:readingBar.settings.freeVoice,e.utterThis.voice=voices.voices.free[i].voice,e.utterThis.volume=parseFloat(readingBar.settings.volume),e.utterThis.rate=utils.calculateRate(readingBar.settings.speed,voices.voices.free[i]),e.onEvent=o,function(t,r){e.utterThis.onend=()=>{e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef),e.onEvent&&e.onEvent({type:"end"})},e.utterThis.onerror=()=>{e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef)},e.utterThis.onstart=()=>{e.onEvent&&e.onEvent({type:"start"})};let n=0;e.utterThis.onboundary=o=>{if("word"==o.name&&(void 0!==o.charLength||void 0!==o.length)){let i=r.substr(o.charIndex,o.charLength||o.length);e.onEvent&&e.onEvent({type:"word",word:i,wordIndex:n,index:t}),n++}}}(n,t),r(voices.voices.free[i])})))).then((t=>{e.synth.speak(e.utterThis),"google"===t.source&&(e.resumeIntervalRef=setInterval((()=>{e.synth.speaking?(e.synth.pause(),e.synth.resume()):clearInterval(e.resumeIntervalRef)}),5e3))})).catch((e=>{}));o({type:"end"})}function r(){return new Promise((t=>{e.resumeIntervalRef&&(clearInterval(e.resumeIntervalRef),e.resumeIntervalRef=null),e.utterThis&&(e.utterThis.onend=null,e.utterThis.onboundary=null,e.utterThis.onerror=null,e.utterThis=null),e.synth.cancel(),t()}))}e.type="free",e.synth=window.speechSynthesis,e.utterThis=null,e.playTimeoutRef=null,e.isStoppedWhenProcessingPlay=!1,e.isProcessingPlay=!1,e.play=t,e.pause=function(t=!0){e.stop(t)},e.stop=function(t=!0){e.onEvent&&t&&e.onEvent({type:"pause"});return e.synth.paused?Promise.resolve().then((()=>new Promise((t=>{e.synth.resume(),t()})))).then((()=>r())).catch((function(e){})):r()},e.resume=function(e,r){t(e,r,!1)},e.onEvent=null,e.resumeIntervalRef=null}function ChromeTtsEngine(){let e=this;e.init=function(){},e.type="free",e.play=function(n,o,i){if(!n||""===n.trim()||!voices.voices.free||voices.voices.free&&0===Object.keys(voices.voices.free).length)return void i({type:"end"});return r().then((function(r){e.onEvent=i,t=0;let s="";reader.previewVoiceKey?(s=reader.previewVoiceKey,reader.previewVoiceKey=""):s="prem"===readingBar.settings.voiceType?readingBar.settings.premVoice:readingBar.settings.freeVoice;let a=voices.voices.free[s].voice.name||voices.voices.free[s].voice.voiceName,l=utils.calculateRate(readingBar.settings.speed,voices.voices.free[s]),c=parseFloat(readingBar.settings.volume);setTimeout((()=>{browser.tts.speak(n,{voiceName:a,rate:l,volume:c,requiredEventTypes:["start","end","word"],desiredEventTypes:["start","end","error","interrupted","word"],onEvent:r=>{!function(r,n,o){if("start"==r.type)e.onEvent&&e.onEvent({type:"start"});else if("end"==r.type)e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef),e.onEvent&&e.onEvent({type:"end"});else if("error"==r.type)e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef);else if("word"==r.type&&(void 0!==r.charLength||void 0!==r.length)){let i=n.substr(r.charIndex,r.charLength||r.length);e.onEvent&&(e.onEvent&&e.onEvent({type:"word",word:i,wordIndex:t,index:o}),t++)}}(r,n,o)}}),"google"===voices.voices.free[s].source&&(e.resumeIntervalRef=setInterval((()=>{browser.tts.isSpeaking((function(t){t?(browser.tts.pause(),browser.tts.resume()):clearInterval(e.resumeIntervalRef)}))}),5e3))}),0)})).catch((e=>{}))},e.stop=function(t=!0){e.onEvent&&t&&e.onEvent({type:"pause"});browser.tts.stop()},e.pause=function(t=!0){e.stop(t)},e.onEvent=null,e.stopIfAlreadySpeaking=r,e.resumeIntervalRef=null;let t=0;function r(){return new Promise((function(t){e.resumeIntervalRef&&(clearInterval(e.resumeIntervalRef),e.resumeIntervalRef=null),browser.tts.isSpeaking((function(e){e&&browser.tts.stop(),t({isSpeaking:e})}))}))}}const freeTts=new WindowSpeechEngine;function OnlineTtsEngine(){class e{constructor(e,t,r,n){}}let t=this;function r(){return Promise.resolve().then((()=>{t.playTimeoutRef&&clearTimeout(t.playTimeoutRef),t.wordMarkTimer&&clearInterval(t.wordMarkTimer),t.onEvent=null,t.playPromise&&t.playPromise.then((()=>{t.audioPlayer.pause()})).catch((e=>{}))})).catch((e=>{}))}async function n(e,r,i){try{if(!e||!e||""===e.trim())return void(t.onEvent&&t.onEvent({type:"end"}));{let s=null!==r?r+"":readingBar.settings.premVoice+"_"+readingBar.settings.speed,c=null!==r?t.preloads[s]:t.previews[s];if(!c)return t.onEvent&&t.onEvent({type:"loading"}),l(e).then((n=>{t.preloads[s]={text:e,blob:n,index:r},o(t.preloads[s],i)})).catch((function(e){}));if(i!==t.playId)throw new Error("invalid playid");try{c.blob.isPending()&&t.onEvent&&t.onEvent({type:"loading"})}catch(e){}(await c.blob).text===e?o(c,i):(a(r),n(e,r,i))}}catch(e){}}async function o(e,r){try{if(r!==t.playId||!e)throw new Error("invalid playId");let o=await e.blob;o.err&&""!==o.err?(n=o.err,t.errCount++,t.errCount>=3||!u(n)?(t.hasError=!0,t.setNumPreloads(2,0),t.onEvent&&t.onEvent({type:"error",err:n,isTempError:u(n)})):(function(e){return 1002===e||1e3===e}(n)&&t.errCount>0&&t.errCount--,t.onEvent&&t.onEvent({type:"end"}))):(t.hasError&&(t.hasError=!1,t.hasInvalidLicenseError=!1,t.invalidLicenseErrorCount=0,t.isStoppedWhenProcessingPlay=!1,t.setNumPreloads(2,4)),async function(e,r){try{t.errCount=0;let s=await e.blob;if(t.audioPlayer.src=s.url,t.currentVoice&&"aca"===t.currentVoice.source?t.audioPlayer.volume=parseFloat(.5*readingBar.settings.volume):t.audioPlayer.volume=parseFloat(readingBar.settings.volume),t.audioPlayer.load(),t.audioPlayer.onended=()=>{t.onEvent&&t.onEvent({type:"end"})},t.audioPlayer.onplay=()=>{t.onEvent&&t.onEvent({type:"start"})},t.audioPlayer.onerror=()=>{t.onEvent&&t.onEvent({type:"error",err:t.audioPlayer.error.message})},t.isStoppedWhenProcessingPlay)i();else try{if(r!==t.playId||!e)throw new Error("invalid playid");"undefined"!=typeof readingBar&&(t.audioPlayer.playbackRate=utils.calculateRate(readingBar.settings.speed)),t.playPromise=t.audioPlayer.play(),n=s.text,o=s.marks,t.audioPlayer.oncanplay=()=>{try{t.wordMarkTimer&&clearInterval(t.wordMarkTimer);let e=0,r=performance.now(),i=(ttsText.getTextChunks(n),0);if(o&&0===o.length){let e=n.split(" "),o=[],s=0;for(let t=0;t<e.length;t++)e[t]?(o.push(s),s=s+e[t].length+1):s++;let a=0,l=1e3*t.audioPlayer.duration/utils.calculateRate(readingBar.settings.speed),c=l/n.length*.95;t.wordMarkTimer=setInterval((()=>{let s=performance.now();if(i=s-r,i>=l||l<=0||isNaN(t.audioPlayer.duration))return void clearInterval(t.wordMarkTimer);let u=Math.floor(i/c);u>n.length?clearInterval(t.wordMarkTimer):u>=o[a]&&t.onEvent&&t.onEvent({type:"word",word:e[a],wordIndex:a++})}),50)}else{const n=[];for(let e=0;e<o.length;e++)n.push(o[e].time/utils.calculateRate(readingBar.settings.speed));t.wordMarkTimer=setInterval((()=>{let s=performance.now();i=s-r,i>n[e]&&t.onEvent&&(t.onEvent({type:"word",word:o[e].word,wordIndex:e++}),e>=o.length&&clearInterval(t.wordMarkTimer))}),50)}}catch(e){}}}catch(e){}}catch(e){}var n,o;t.isProcessingPlay=!1,t.isStoppedWhenProcessingPlay=!1}(e,r))}catch(n){}var n}function i(e){return t.onEvent&&e&&t.onEvent({type:"pause"}),t.isProcessingPlay&&(t.isStoppedWhenProcessingPlay=!0),r()}async function s(e,r){try{if(r!==t.playId)throw new Error("inavlid playId");let n=e+"";if(t.preloads[n])return;{let r=ttsText.textsForTts[e].processed;if(!r||""===r.trim())return;t.preloads[n]={text:r,blob:d(l(r)),index:e}}}catch(e){}}function a(e){null!==e&&delete t.preloads[e+""]}function l(t){return new Promise((async(r,n)=>{let o=3,i=new e("","",[],"");for(;o>0;){const e=await c(t);e.decrementAttemptCount?o--:(o=0,i=e)}r(i)})).catch((e=>{}))}function c(e){return new Promise((r=>{const n=function(e,r){let n="";if(reader.previewVoiceKey?(n=voices.voices[readingBar.settings.voiceType][reader.previewVoiceKey],reader.previewVoiceKey=""):n=voices.voices[readingBar.settings.voiceType][readingBar.settings[readingBar.settings.voiceType+"Voice"]],t.ttsEndpoint=t.premTtsEndpoint,"plus"===n.type&&(t.ttsEndpoint=t.plusTtsEndpoint),t.currentVoice=n,!n.id||!n.source)throw new Error("error");let o="",i="";return i=null!==n?"&r="+n.id+"&s=0&v="+n.source:"&r=21&s=0&v=aca",r&&r.email?(o+="?e="+r.email,void 0!==r.license&&(o+="&l="+r.license),r.ownerEmail&&(o+="&o="+r.ownerEmail),o+=i):o="?l=0"+i,o+="&vn="+chrome.runtime.getManifest().version+"&sm="+t.isSpeechMark,t.ttsEndpoint+o}(t.ttsEndpoint,readingBar.settings.userInfo);chrome.runtime.sendMessage({fn:"sendTtsRequest",queryEndpoint:n,text:e},(async function(e){const n=await function(e){if(e.url){const t=atob(e.url.split(",")[1]),r=[];for(let e=0;e<t.length;e++)r.push(t.charCodeAt(e));e.url=window.URL.createObjectURL(new Blob([new Uint8Array(r)],{type:"audio/mpeg"}))}return Promise.resolve(e)}(e);return""!==n.err?(function(e){if(1002==e||1005==e||1001==e||1003==e||1004==e||1006==e||"ERR_LICENSE_INVALID"==e||"Limit Exceeded"==e||"ERR_INVALID_REQUEST"==e||"ERR_EMPTY_TEXT"==e)return!0}(n.err)||("Too Many Requests"===n.err&&(t.hasTooManyRequestsError=!0),n.decrementAttemptCount=!0),r(n)):r(n)}))})).catch((e=>{}))}function u(e){return 1001!=e&&1003!=e&&1004!=e&&1005!=e&&1006!=e&&"ERR_LICENSE_INVALID"!=e&&"Limit Exceeded"!=e&&"ERR_EMPTY_TEXT"!=e}function d(e){try{if(e.isResolved)return e;let t=!0,r=!1,n=!1,o=e.then((function(e){return n=!0,t=!1,e}),(function(e){throw r=!0,t=!1,e}));return o.isFulfilled=function(){return n},o.isPending=function(){return t},o.isRejected=function(){return r},o}catch(t){return e}}t.type="online",t.ttsEndpoint,t.premTtsEndpoint="https://avf3h4i1vc.execute-api.us-east-1.amazonaws.com/prod-cpm/tts",t.plusTtsEndpoint="https://6rbmmgxig8.execute-api.us-east-1.amazonaws.com/prod-cps/tts",t.audioPlayer=null,t.errCount=0,t.playId=void 0,t.numPreloads={prev:2,next:4},t.preloads={},t.previews={},t.hasError=!1,t.hasTooManyRequestsError=!1,t.onEvent=null,t.wordMarkTimer=null,t.play=function(e,o,i){t.playId=Date.now();let l=t.playId;return t.isStoppedWhenProcessingPlay?(t.isProcessingPlay=!1,t.isStoppedWhenProcessingPlay=!1,Promise.resolve()):r().then((()=>(t.onEvent=i,n(e,o,l)))).then((()=>{if(null!==o&&l===t.playId)return async function(e,r){let n={};n[e+""]=!0;for(let o=1;o<t.numPreloads.next+1&&!t.isStoppedWhenProcessingPlay;o++)try{let t=await ttsText.getIndexOfNNextSentence(o,e);if(-1===t)break;n[t+""]=!0,s(t,r)}catch(e){continue}for(let r=1;r<t.numPreloads.prev+1&&!t.isStoppedWhenProcessingPlay;r++)try{let t=await ttsText.getIndexOfNPrevSentence(r,e);if(-1===t)break;n[t+""]=!0}catch(e){continue}!function(e){for(let r in t.preloads){let n=t.preloads[r];e[r]||a(n.index)}}(n)}(o,l)})).catch((e=>{}))},t.pause=function(e=!0){t.stop(e)},t.stop=i,t.clearPreloads=function(){t.preloads={}},t.clearBlobsWithError=async function(){for(let e in t.preloads){let r=t.preloads[e],n=await r.blob;"ERR_CONVERT_LIMIT"!==n.err&&1005!=n.err&&1006!==n.err&&"ERR_LICENSE_INVALID"!==n.err||a(r.index)}},t.setNumPreloads=function(e,r){t.numPreloads={prev:e,next:r}},t.isProcessingPlay=!1,t.isStoppedWhenProcessingPlay=!1,t.playPromise=null,t.hasInvalidLicenseError=!1,t.invalidLicenseErrorCount=0,t.currentVoice=null,t.isSpeechMark=!0,t.audioPlayer=document.createElement("AUDIO")}var onlineTts=onlineTts||new OnlineTtsEngine;